server {
    listen 80;
    server_name example.com;

    # Cache purge location
    location ~ /purge/(.*) {
        # Allow only internal network to purge cache
        allow 127.0.0.1;
        allow 192.168.0.0/24;  # Adjust for your internal network
        deny all;

        proxy_cache_purge my_cache $scheme://$host/$1;
    }

    # Regular location for serving content
    location / {
        # Cache only images
        location ~* \.(jpg|jpeg|png|gif|ico|webp)$ {
            proxy_cache my_cache;
            proxy_cache_key $scheme://$host$request_uri;
            proxy_cache_min_uses 2;  # Cache only after 2 requests
            proxy_cache_valid 200 60m;  # Cache successful responses for 60 minutes
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            
            # Add cache status to response headers
            add_header X-Cache-Status $upstream_cache_status;

            proxy_pass http://backend;  # Your backend server
        }

        # Other location configurations...
        proxy_pass http://backend;
    }
} 