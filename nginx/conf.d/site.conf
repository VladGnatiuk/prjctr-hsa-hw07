server {
    listen 80;
    server_name localhost;

    # Cache purge location
    location ~ /purge/(.*) {
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # Docker network range
        allow 192.168.0.0/16; # Local network range
        allow 10.0.0.0/8;     # Another common private network range
        deny all;

        content_by_lua_block {
            local cache_key = ngx.var.scheme .. "://" .. ngx.var.host .. "/" .. ngx.var.1
            local cache = ngx.shared.lua_cache
            cache:delete(cache_key)
            ngx.say("Cache purged for: " .. cache_key)
        }
    }

    # Direct file serving location
    location /images_direct/ {
        alias /usr/share/nginx/images/;
        internal;  # Only for internal redirects
    }

    # Images location with caching
    location /images/ {
        proxy_cache my_cache;
        proxy_cache_key $scheme://$host$request_uri;
        proxy_cache_min_uses 2;
        proxy_cache_valid 200 60m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        add_header X-Cache-Status $upstream_cache_status always;

        # Rewrite and proxy to internal location
        rewrite ^/images/(.*) /images_direct/$1 break;
        proxy_pass http://localhost;
    }
} 